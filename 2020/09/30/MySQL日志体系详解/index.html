<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,InnoDB," />










<meta name="description" content="前言日志是MySQL数据库的重要组成部分。日志文件中记录着MySQL数据库运行期间发生的变化；也就是说用来记录MySQL数据库的客户端连接状况、SQL语句的执行情况和错误信息等。当数据库遭到意外的损坏时，可以通过日志查看文件出错的原因，并且可以通过日志文件进行数据恢复。 MySQL的日志体系有如下几种分类：  错误日志 查询日志 慢查询日志 事务日志(Redo log&#x2F;undo log) 二进制日">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL日志体系详解">
<meta property="og:url" content="http://yoursite.com/2020/09/30/MySQL%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="cherish">
<meta property="og:description" content="前言日志是MySQL数据库的重要组成部分。日志文件中记录着MySQL数据库运行期间发生的变化；也就是说用来记录MySQL数据库的客户端连接状况、SQL语句的执行情况和错误信息等。当数据库遭到意外的损坏时，可以通过日志查看文件出错的原因，并且可以通过日志文件进行数据恢复。 MySQL的日志体系有如下几种分类：  错误日志 查询日志 慢查询日志 事务日志(Redo log&#x2F;undo log) 二进制日">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-cecfbe4ae32adc82200e726bfcee974be9f.png">
<meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-9f38776eb1af0452f182405bcc051088b47.png">
<meta property="og:image" content="https://oscimg.oschina.net/oscnet/up-4485cce5b262eea9f252ec10f4ce6b93f8b.png">
<meta property="article:published_time" content="2020-09-30T15:44:48.000Z">
<meta property="article:modified_time" content="2020-09-30T15:46:21.362Z">
<meta property="article:author" content="cherish-ls">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="InnoDB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oscimg.oschina.net/oscnet/up-cecfbe4ae32adc82200e726bfcee974be9f.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/09/30/MySQL日志体系详解/"/>





  <title>MySQL日志体系详解 | cherish</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">cherish</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">返朴归真</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/30/MySQL%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cherish-ls">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://oscimg.oschina.net/oscnet/up-c01f8b7b68770ed58c420d68072f773a30b.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cherish">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL日志体系详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-30T23:44:48+08:00">
                2020-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">关系型数据库</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/30/MySQL%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/09/30/MySQL日志体系详解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  8.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  34
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>日志是MySQL数据库的重要组成部分。日志文件中记录着MySQL数据库运行期间发生的变化；也就是说用来记录MySQL数据库的客户端连接状况、SQL语句的执行情况和错误信息等。当数据库遭到意外的损坏时，可以通过日志查看文件出错的原因，并且可以通过日志文件进行数据恢复。</p>
<p>MySQL的日志体系有如下几种分类：</p>
<ol>
<li>错误日志</li>
<li>查询日志</li>
<li>慢查询日志</li>
<li><strong>事务日志(Redo log/undo log)</strong></li>
<li><strong>二进制日志</strong></li>
<li>中继日志</li>
</ol>
<p>其中标粗的事务日志和二进制日志，是重中之重。</p>
<h1 id="1-错误日志"><a href="#1-错误日志" class="headerlink" title="1 错误日志"></a>1 错误日志</h1><p>在默认情况下，MySQL的错误日志是开启的，且无法被禁止。在没有指定的情况下，它一般是存储在数据库的数据文件目录中，名称为hostname.err，其中，hostname为服务器主机名。</p>
<h2 id="1-1-错误日志的内容"><a href="#1-1-错误日志的内容" class="headerlink" title="1.1 错误日志的内容"></a>1.1 错误日志的内容</h2><ol>
<li>服务器启动和关闭过程中的信息，未必是错误信息，比如mysql是如何去初始化存储引擎的过程记录在错误日志里等等</li>
<li>服务器运行过程中的错误信息（或者告警信息），比如sock文件找不到，无法加载mysql数据库的数据文件，如果忘记初始化mysql或data dir路径找不到，或权限不正确等 都会记录在此</li>
<li>事件调度器运行一个事件时产生的信息，一旦mysql调度启动一个计划任务（event scheduler）的时候，它也会将相关信息记录在错误日志中</li>
<li>在从服务器上启动从服务器进程时产生的信息，在复制环境下，从服务器进程的信息也会被记录进错误日志</li>
</ol>
<h2 id="1-2-配置相关"><a href="#1-2-配置相关" class="headerlink" title="1.2 配置相关"></a>1.2 配置相关</h2><h3 id="1-2-1-开启错误日志"><a href="#1-2-1-开启错误日志" class="headerlink" title="1.2.1 开启错误日志"></a>1.2.1 开启错误日志</h3><ol>
<li><p>在/etc/my.cnf配置文件中设置：</p>
<ul>
<li>如果需要手动指定错误日志路径的话只需要在<code>[mysqld]</code>字段中增加相关配置：</li>
<li><img src="https://oscimg.oschina.net/oscnet/up-cecfbe4ae32adc82200e726bfcee974be9f.png" alt=""></li>
</ul>
</li>
<li><p>如果没有在my.cnf配置文件中指定错误日志</p>
<ul>
<li>MySQL会自动将错误日志文件存放在datadir（数据目录）下，名为hostname.err（hostname根据实际主机名变化）。</li>
</ul>
</li>
<li><p>如果是通过YUM源进行安装</p>
<ul>
<li>错误日志会被配置在/var/log/mysqld.log中，这个也是由自动创建出的/etc/my.cnf所指定的。</li>
</ul>
</li>
</ol>
<h3 id="1-2-2-设置错误日志时区"><a href="#1-2-2-设置错误日志时区" class="headerlink" title="1.2.2 设置错误日志时区"></a>1.2.2 设置错误日志时区</h3><p>错误日志默认是使用utc时间，可以修改为系统时间方便查看</p>
<p><code>mysql &gt; set global log_timestamps=&#39;SYSTEM&#39;`</code></p>
<h3 id="1-2-3-删除错误日志"><a href="#1-2-3-删除错误日志" class="headerlink" title="1.2.3 删除错误日志"></a>1.2.3 删除错误日志</h3><p>在mysql5.5.7之前：数据库管理员可以删除很长时间之前的错误日志，以保证mysql服务器上的硬盘空间。mysql数据库中，可以使用mysqladmin命令开启新的错误日志。mysqladmin命令的语法如下：</p>
<p><code>mysqladmin –u root –pflush-logs</code></p>
<p>也可以使用登录mysql数据库中使用FLUSHLOGS语句来开启新的错误日志。</p>
<p>在mysql5.5.7之后：服务器将关闭此项功能。只能使用重命名原来的错误日志文件，手动冲洗日志创建一个新的：方式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@stu18 data]<span class="comment"># mv stu18.magedu.com.err  stu18.magedu.com.err.old</span></span><br><span class="line">[root@stu18 data]<span class="comment">#  mysqladmin flush-logs</span></span><br><span class="line">[root@stu18 data]<span class="comment"># ls</span></span><br><span class="line">hellodb  myclass  mysql-bin.000003  mysql-bin.index           stu18.magedu.com.pid     ibda</span><br></pre></td></tr></table></figure>

<p>或者手动清理掉错误日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &gt; &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br></pre></td></tr></table></figure>

<h2 id="1-3-查看错误日志和配置"><a href="#1-3-查看错误日志和配置" class="headerlink" title="1.3 查看错误日志和配置"></a>1.3 查看错误日志和配置</h2><p>查看log_error的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;log_error&#39;;</span><br><span class="line">+---------------+---------------------+</span><br><span class="line">| Variable_name | Value               |</span><br><span class="line">+---------------+---------------------+</span><br><span class="line">| log_error     | &#x2F;var&#x2F;log&#x2F;mysqld.log |</span><br><span class="line">+---------------+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看错误日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]# tailf &#x2F;var&#x2F;log&#x2F;mysqld.log</span><br><span class="line">130813  15:30:50  InnoDB: Starting shutdown...</span><br><span class="line">130813  15:30:51  InnoDB: Shutdown completed;  log sequence number 1630920</span><br><span class="line">130813 15:30:51  [Note] &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld: Shutdown complete</span><br><span class="line">130813 15:30:52  mysqld_safe mysqld from pid file &#x2F;mydata&#x2F;data&#x2F;stu18.magedu.com.pid ended</span><br><span class="line">130813 15:30:53  mysqld_safe Starting mysqld daemon with databases from &#x2F;mydata&#x2F;data</span><br><span class="line">130813 15:30:54  InnoDB: The InnoDB memory heap is disabled     #禁用了InnoDB memory的堆功能。</span><br><span class="line">130813 15:30:54  InnoDB: Mutexes and rw_locks use GCC atomic builtins #Mutexes（互斥量）和rw_locks（行级锁）是GCC编译的是InnoDB内置的。</span><br><span class="line">130813 15:30:54  InnoDB: Compressed tables use zlib 1.2.3     #默认压缩工具是zlib</span><br><span class="line">130813 15:30:55  InnoDB: Initializing buffer pool, size &#x3D; 128.0M    #InnoDB引擎的缓冲池（buffer pool）的值大小</span><br><span class="line">130813 15:30:55  InnoDB: Completed initialization of buffer pool</span><br><span class="line">130813 15:30:55  InnoDB: highest supported file format is Barracuda.</span><br><span class="line">130813  15:30:57  InnoDB: Waiting for the  background threads to start</span><br><span class="line">130813 15:30:58  InnoDB: 5.5.33 started; log sequence number 1630920</span><br><span class="line">130813 15:30:58  [Note] Server hostname (bind-address): &#39;0.0.0.0&#39;; port: 3306</span><br><span class="line">130813 15:30:58  [Note]   - &#39;0.0.0.0&#39; resolves to  &#39;0.0.0.0&#39;;  #0.0.0.0会反解主机名，这里反解失败</span><br><span class="line">130813 15:30:58  [Note] Server socket created on IP: &#39;0.0.0.0&#39;.</span><br><span class="line">130813 15:30:58  [Note] Event Scheduler: Loaded 0 events    #事件调度器没有任何事件，因为没有装载。</span><br><span class="line">130813 15:30:58  [Note] &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld: ready for connections. #mysql启动完成等待客户端的请求。</span><br><span class="line">Version:  &#39;5.5.33-log&#39;  socket:  &#39;&#x2F;tmp&#x2F;mysql.sock&#39;  port: 3306  Source distribution  #创建一个本地sock用于本地连接。</span><br></pre></td></tr></table></figure>

<h1 id="2-查询日志"><a href="#2-查询日志" class="headerlink" title="2 查询日志"></a>2 查询日志</h1><p>查询日志在MySQL中被称为general log(通用日志)，查询日志里的内容不要被”查询日志”误导，认为里面只存储select语句，其实不然，查询日志里面记录了数据库执行的<strong>所有命令</strong>，不管语句是否正确，都会被记录，因为本质上insert/update/delete语句中，都包含了查询操作:</p>
<ul>
<li>insert的查询是为了避免数据冲突，如果此前插入过数据，当前插入的数据如果跟主键或唯一键的数据重复那肯定会报错</li>
<li>update时也会查询，因为更新的时候是更新某一块数据，要先根据where定位到更新的记录。</li>
<li>delete查询，只删除符合条件的数据，同样是根据where定位。</li>
</ul>
<p>因此增删改查都会产生日志，在并发操作非常多的场景下，查询信息会非常多，那么如果都记录下来会导致IO非常大，影响MySQL性能，因此如果不是在调试环境下，是不建议开启查询日志功能的。</p>
<p>查询日志的开启有助于帮助我们分析哪些语句执行密集，执行密集的select语句对应的数据是否能够被缓存，同时也可以帮助我们分析问题，所以，我们可以根据自己的实际情况来决定是否开启查询日志。</p>
<h2 id="2-1-查询日志配置相关"><a href="#2-1-查询日志配置相关" class="headerlink" title="2.1 查询日志配置相关"></a>2.1 查询日志配置相关</h2><h3 id="2-1-1-查看配置"><a href="#2-1-1-查看配置" class="headerlink" title="2.1.1 查看配置"></a>2.1.1 查看配置</h3><p>所以如果你要判断MySQL数据库是否开启了查询日志，可以使用下面命令。general_log为ON表示开启查询日志，OFF表示关闭查询日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;%general_log%&#39; or variables like &#39;%log_output%&#39;;</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| Variable_name    | Value                        |</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| general_log      | OFF                          |</span><br><span class="line">| general_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log |</span><br><span class="line">| log_output       | FILE                         |</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>参数general_log用来控制开启、关闭MySQL查询日志</li>
<li>参数general_log_file用来控制查询日志的位置</li>
<li>如果开启了查询日志，参数log_output控制着查询日志的存储方式，log_output可以设置为以下4种值:<ol>
<li>FILE : 表示日志存储在文件中</li>
<li>TABLE : 表示日志存储在mysql库中的general_log表中</li>
<li>FILE, TABLE : 表示将日志同时存储在文件和general_log表中，改值会徒增很多IO压力，一般不会这样设置</li>
<li>NONE : 表示不记录日志，即使general_log设置为ON， 如果log_output设置为NONE，也不会记录查询日志</li>
</ol>
</li>
</ul>
<blockquote>
<p>log_output不仅控制查询日志的输出，也控制着慢查询日志的输出，即: log_output设置为FILE，就表示查询日志和慢查询日志都存放在文件中，设置为TABLE，查询日志和慢查询日志都存放在mysql库中的general_log表中</p>
</blockquote>
<h3 id="2-1-2-开启或关闭查询日志"><a href="#2-1-2-开启或关闭查询日志" class="headerlink" title="2.1.2 开启或关闭查询日志"></a>2.1.2 开启或关闭查询日志</h3><ul>
<li>方法1: 在配置文件中设置(不推荐)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#可以在my.cnf里添加,1开启（0关闭）,当然了,这样要重启才能生效,有点多余了</span><br><span class="line">general-log &#x3D; 1</span><br><span class="line">log_output&#x3D;&#39;table&#39;</span><br></pre></td></tr></table></figure>

<p>然后重启MySQL实例</p>
<ul>
<li>方法2 : 通过命令设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#也可以设置变量那样更改,1开启（0关闭）,即时生效,不用重启,首选当然是这样的了</span><br><span class="line">set global general_log&#x3D;1</span><br><span class="line">set global log_output&#x3D;&#39;table&#39;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过该方式设置，MySQL实例重启后，相关配置又恢复到默认值。如果只是短暂时间内使用，推荐使用命令行方式</p>
</blockquote>
<h3 id="2-1-3-修改查询日志名称或位置"><a href="#2-1-3-修改查询日志名称或位置" class="headerlink" title="2.1.3 修改查询日志名称或位置"></a>2.1.3 修改查询日志名称或位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;general_log%&#39;;</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| Variable_name    | Value                        |</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| general_log      | ON                           |</span><br><span class="line">| general_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log |</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global general_log&#x3D;&#39;OFF&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global general_log_file&#x3D;&#39;&#x2F;u02&#x2F;mysql_log.log&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set global general_log&#x3D;&#39;ON&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>

<h2 id="2-2-查询日志的查看"><a href="#2-2-查询日志的查看" class="headerlink" title="2.2 查询日志的查看"></a>2.2 查询日志的查看</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from mysql.general_log;</span><br><span class="line">+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+</span><br><span class="line">| event_time          | user_host                 | thread_id | server_id | command_type | argument                         |</span><br><span class="line">+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+</span><br><span class="line">| 2017-07-06 12:32:05 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like &#39;general%&#39;   |</span><br><span class="line">| 2017-07-06 12:32:28 | root[root] @ localhost [] |         1 |         1 | Query        | show variables like &#39;log_output&#39; |</span><br><span class="line">| 2017-07-06 12:32:41 | root[root] @ localhost [] |         1 |         1 | Query        | select * from MyDB.test          |</span><br><span class="line">| 2017-07-06 12:34:36 | [root] @ localhost []     |         3 |         1 | Connect      | root@localhost on                |</span><br><span class="line">| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Query        | KILL QUERY 1                     |</span><br><span class="line">| 2017-07-06 12:34:36 | root[root] @ localhost [] |         3 |         1 | Quit         |                                  |</span><br><span class="line">| 2017-07-06 12:34:51 | root[root] @ localhost [] |         1 |         1 | Query        | select * from mysql.general_log  |</span><br><span class="line">+---------------------+---------------------------+-----------+-----------+--------------+----------------------------------+</span><br><span class="line">7 rows in set (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-查询日志的归档"><a href="#2-3-查询日志的归档" class="headerlink" title="2.3 查询日志的归档"></a>2.3 查询日志的归档</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; system mv &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log  &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log.20170706</span><br><span class="line"></span><br><span class="line">mysql&gt; system mysqladmin flush-logs -p</span><br><span class="line"></span><br><span class="line">Enter password:</span><br></pre></td></tr></table></figure>

<p>或者你在shell中执行下面命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@DB-Server mysql]# mv &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log  &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;DB-Server.log.20170706</span><br><span class="line"></span><br><span class="line">[root@DB-Server mysql]# mysqladmin flush-logs -p</span><br><span class="line"></span><br><span class="line">Enter password:</span><br></pre></td></tr></table></figure>

<h1 id="3-慢查询日志"><a href="#3-慢查询日志" class="headerlink" title="3 慢查询日志"></a>3 慢查询日志</h1><p>慢查询会导致CPU，IOPS，内存消耗过高。当数据库遇到性能瓶颈时，大部分时间都是由于慢查询导致的。 开启慢查询日志，可以让MySQL记录下查询超过指定时间的语句，之后运维人员通过定位分析，能够很好的优化数据库性能。</p>
<p>慢查询日志记录的慢查询不仅仅是执行比较慢的SELECT语句，还有INSERT，DELETE，UPDATE，CALL等DML操作，只要超过了指定时间，都可以称为”慢查询”，被记录到慢查询日志中。</p>
<p>默认情况下，慢查询日志是不开启的，只有手动开启了，慢查询才会被记录到慢查询日志中。</p>
<h2 id="3-1-慢查询日志配置相关"><a href="#3-1-慢查询日志配置相关" class="headerlink" title="3.1 慢查询日志配置相关"></a>3.1 慢查询日志配置相关</h2><h3 id="3-1-1-查看配置"><a href="#3-1-1-查看配置" class="headerlink" title="3.1.1 查看配置"></a>3.1.1 查看配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &quot;%slow%&quot; or variables like &quot;%log_queries_not_using_indexes%&quot;;</span><br><span class="line">+-------------------------------+-------------------------------------------------+</span><br><span class="line">| Variable_name                 | Value                                           |</span><br><span class="line">+-------------------------------+-------------------------------------------------+</span><br><span class="line">| log_slow_admin_statements     | OFF                                             |</span><br><span class="line">| log_slow_slave_statements     | OFF                                             |</span><br><span class="line">| slow_launch_time              | 2                                               |</span><br><span class="line">| slow_query_log                | OFF                                             |</span><br><span class="line">| slow_query_log_file           | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;iz2zeaf3cg1099kiidi06mz-slow.log |</span><br><span class="line">| log_queries_not_using_indexes | ON                                              |</span><br><span class="line">+-------------------------------+-------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>其中</p>
<ul>
<li>slow_query_log：慢查询开关，表示是否打开慢查询日志</li>
<li>long_query_time：慢查询指定时间设置，表示”多长时间的查询”被认定为”慢查询”，单位是秒(s)，默认是10s，即超过10s的查询都被认定为慢查询。</li>
<li>log_queries_not_using_indexes：表示如果运行的SQL语句没有使用到索引，是否也被当作慢查询语句记录到慢查询记录中，OFF表示不记录，ON表示记录。</li>
<li>如果开启了查询日志，参数log_output控制着查询日志的存储方式，log_output可以设置为以下4种值:<ol>
<li>FILE : 表示日志存储在文件中</li>
<li>TABLE : 表示日志存储在mysql库中的general_log表中</li>
<li>FILE, TABLE : 表示将日志同时存储在文件和general_log表中，改值会徒增很多IO压力，一般不会这样设置</li>
<li>NONE : 表示不记录日志，即使general_log设置为ON， 如果log_output设置为NONE，也不会记录查询日志</li>
</ol>
</li>
<li>slow_query_log_file：当使用文件存储慢查询日志时(log_output设置为”FILE”或者”FILE,TABLE”时)，制定慢查询日志存储在哪个文件中，默认的文件名是”主机名-slow.log”，存储目录为数据目录</li>
<li>log_throttle_queries_not_using_indexes: MySQL5.6.5版本新引入的参数，用来限制没有使用索引的语句每分钟记录到慢查询日志中的次数。在生产环境中，有可能有很多没有使用索引的语句，可能会导致慢查询日志快速增长。</li>
</ul>
<blockquote>
<p>log_output不仅控制查询日志的输出，也控制着慢查询日志的输出，即: log_output设置为FILE，就表示查询日志和慢查询日志都存放在文件中，设置为TABLE，查询日志和慢查询日志都存放在mysql库中的general_log表中</p>
</blockquote>
<h3 id="3-1-2-开启或关闭慢查询日志"><a href="#3-1-2-开启或关闭慢查询日志" class="headerlink" title="3.1.2 开启或关闭慢查询日志"></a>3.1.2 开启或关闭慢查询日志</h3><ul>
<li>方法1: 在配置文件中设置(不推荐)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#可以在my.cnf里添加,1开启（0关闭）,当然了,这样要重启才能生效,有点多余了</span><br><span class="line">slow_query_log&#x3D;1</span><br></pre></td></tr></table></figure>

<p>然后重启MySQL实例</p>
<ul>
<li>方法2 : 通过命令设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#也可以设置变量那样更改,ON开启（OFF关闭）,即时生效,不用重启,首选当然是这样的了</span><br><span class="line">mysql&gt; set global slow_query_log&#x3D;&#39;ON&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 设置慢查询时间</span><br><span class="line">mysql&gt; set global long_query_time&#x3D;0.05;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 关闭慢查询</span><br><span class="line">mysql&gt; set global slow_query_log&#x3D;&#39;OFF&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过该方式设置，MySQL实例重启后，相关配置又恢复到默认值。如果只是短暂时间内使用，推荐使用命令行方式</p>
</blockquote>
<blockquote>
<p>设置long_query_time这个阈值之后，MySQL数据库会记录运行时间超过该值的所有SQL语句，但对于运行时间正好等于 long_query_time 的情况，并不会被记录下。可以设置 long_query_time为0来捕获所有的查询</p>
</blockquote>
<h3 id="3-1-3-查看当前有多少条慢日志"><a href="#3-1-3-查看当前有多少条慢日志" class="headerlink" title="3.1.3 查看当前有多少条慢日志"></a>3.1.3 查看当前有多少条慢日志</h3><p>如果你想查询有多少条慢查询记录，可以使用系统变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status like &#39;%slow_queries%&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Slow_queries  | 0     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; &#96;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-慢查询日志分析工具pt-query-digest"><a href="#3-2-慢查询日志分析工具pt-query-digest" class="headerlink" title="3.2 慢查询日志分析工具pt-query-digest"></a>3.2 慢查询日志分析工具pt-query-digest</h2><h3 id="3-2-1-pt-query-digest的使用"><a href="#3-2-1-pt-query-digest的使用" class="headerlink" title="3.2.1 pt-query-digest的使用"></a>3.2.1 pt-query-digest的使用</h3><p>pt-query-digest 是分析MySQL查询日志最有力的工具，该工具功能强大，它可以分析binlog，Generallog，slowlog，也可以通过show processlist或者通过 tcpdump 抓取的MySQL协议数据来进行分析，比 mysqldumpslow 更具体，更完善。</p>
<p>下载安装 <a href="https://www.percona.com/downloads/percona-toolkit/LATEST/" target="_blank" rel="noopener">https://www.percona.com/downloads/percona-toolkit/LATEST/</a></p>
<p>在windows下，下载tar.gz包，解压之后，使用perl命令运行</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-9f38776eb1af0452f182405bcc051088b47.png" alt=""></p>
<p>其命令格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest [OPTIONS] [FILES] [DSN]</span><br><span class="line">--create-review-table  当使用--review参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--create-history-table  当使用--history参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--filter  对输入的慢查询按指定的字符串进行匹配过滤后再进行分析</span><br><span class="line">--limit    限制输出结果百分比或数量，默认值是20,即将最慢的20条语句输出，如果是50%则按总响应时间占比从大到小排序，输出到总和达到50%位置截止。</span><br><span class="line">--host  mysql服务器地址</span><br><span class="line">--user  mysql用户名</span><br><span class="line">--password  mysql用户密码</span><br><span class="line">--history 将分析结果保存到表中，分析结果比较详细，下次再使用--history时，如果存在相同的语句，且查询所在的时间区间和历史表中的不同，则会记录到数据表中，可以通过查询同一CHECKSUM来比较某类型查询的历史变化。</span><br><span class="line">--review 将分析结果保存到表中，这个分析只是对查询条件进行参数化，一个类型的查询一条记录，比较简单。当下次使用--review时，如果存在相同的语句分析，就不会记录到数据表中。</span><br><span class="line">--output 分析结果输出类型，值可以是report(标准分析报告)、slowlog(Mysql slow log)、json、json-anon，一般使用report，以便于阅读。</span><br><span class="line">--since 从什么时间开始分析，值为字符串，可以是指定的某个”yyyy-mm-dd [hh:mm:ss]”格式的时间点，也可以是简单的一个时间值：s(秒)、h(小时)、m(分钟)、d(天)，如12h就表示从12小时前开始统计。</span><br><span class="line">--until 截止时间，配合—since可以分析一段时间内的慢查询。</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-pt-query-digest的结果"><a href="#3-2-2-pt-query-digest的结果" class="headerlink" title="3.2.2 pt-query-digest的结果"></a>3.2.2 pt-query-digest的结果</h3><p>输出结果分为三部分</p>
<ol>
<li>总体统计结果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 该工具执行日志分析的用户时间，系统时间，物理内存占用大小，虚拟内存占用大小</span><br><span class="line"># 343ms user time, 78ms system time, 0 rss, 0 vsz</span><br><span class="line"># 工具执行时间</span><br><span class="line"># Current date: Thu Mar 29 15:51:38 2018</span><br><span class="line"># 运行分析工具的主机名</span><br><span class="line"># Hostname: NB2015041602</span><br><span class="line"># 被分析的文件名</span><br><span class="line"># Files: &#x2F;d&#x2F;xampp&#x2F;mysql&#x2F;data&#x2F;NB2015041602-slow.log</span><br><span class="line"># 语句总数量，唯一的语句数量，QPS，并发数</span><br><span class="line"># Overall: 5 total, 3 unique, 0.00 QPS, 0.05x concurrency ________________</span><br><span class="line"># 日志记录的时间范围</span><br><span class="line"># Time range: 2018-03-28 14:02:06 to 14:22:10</span><br><span class="line"># 属性               总计      最小    最大    平均    95%  标准    中等</span><br><span class="line"># Attribute          total     min     max     avg     95%  stddev  median</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;     &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># 语句执行时间</span><br><span class="line"># Exec time            60s     10s     17s     12s     17s      3s     11s</span><br><span class="line"># 锁占用时间</span><br><span class="line"># Lock time            1ms       0   500us   200us   490us   240us       0</span><br><span class="line"># 发送到客户端的行数</span><br><span class="line"># Rows sent             50      10      10      10      10       0      10</span><br><span class="line"># select语句扫描行数</span><br><span class="line"># Rows examine     629.99k  45.43k 146.14k 126.00k 143.37k  39.57k 143.37k</span><br><span class="line"># 查询的字符数</span><br><span class="line"># Query size         2.81k     235   1.36k  575.40   1.33k  445.36  234.30</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查询分组统计结果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># rank：所有语句的排序，默认按照查询时间降序排序，通过--order-by指定</span><br><span class="line"># # query id：语句的id，（去掉多余空格和文本字符，计算hash值）</span><br><span class="line"># response：总的响应时间</span><br><span class="line"># time：该查询在本次分析中总的时间占比</span><br><span class="line"># calls：执行次数，即本次分析总共有多少条这种类型的查询语句</span><br><span class="line"># r&#x2F;call：平均每次执行的响应时间</span><br><span class="line"># v&#x2F;m：响应时间variance-to-mean的比率</span><br><span class="line"># item：查询对象</span><br><span class="line"></span><br><span class="line"># Profile</span><br><span class="line"># Rank Query ID           Response time Calls R&#x2F;Call  V&#x2F;M   Item</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">#    1 0x96112A601F7BCCC0 32.9042 55.0%     3 10.9681  0.01 SELECT affiliatemerchant_list user_list</span><br><span class="line">#    2 0x70885F9703A0E38D 17.2162 28.8%     1 17.2162  0.00 SELECT normalmerchant merchant_mapping normalmerchant_addinfo merchant_search_filter affiliatemerchant_list user_list</span><br><span class="line">#    3 0x43D8527285567FC4  9.7367 16.3%     1  9.7367  0.00 SELECT affiliatemerchant_list user_list affiliatemerchant_list user_list</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>每一种查询的详细统计结果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># id：查询的id号，和上面的query id对应</span><br><span class="line"># # databases：数据库名</span><br><span class="line"># users：各个用户执行的次数（占比）</span><br><span class="line"># query_time_distribution：查询时间分布，长短体现区间占比</span><br><span class="line"># tables：查询中设计到的表</span><br><span class="line"># explain：sql语句</span><br><span class="line"></span><br><span class="line"># Query 1: 0.00 QPS, 0.03x concurrency, ID 0x96112A601F7BCCC0 at byte 2647</span><br><span class="line"># This item is included in the report because it matches --limit.</span><br><span class="line"># Scores: V&#x2F;M &#x3D; 0.01</span><br><span class="line"># Time range: 2018-03-28 14:03:31 to 14:19:54</span><br><span class="line"># Attribute    pct   total     min     max     avg     95%  stddev  median</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># Count         60       3</span><br><span class="line"># Exec time     54     33s     11s     11s     11s     11s   243ms     11s</span><br><span class="line"># Lock time     50   500us       0   500us   166us   490us   231us       0</span><br><span class="line"># Rows sent     60      30      10      10      10      10       0      10</span><br><span class="line"># Rows examine  69 438.42k 146.14k 146.14k 146.14k 146.14k       0 146.14k</span><br><span class="line"># Query size    24     707     235     236  235.67  234.30       0  234.30</span><br><span class="line"># String:</span><br><span class="line"># Databases    database_base</span><br><span class="line"># Hosts        localhost</span><br><span class="line"># Users        root</span><br><span class="line"># Query_time distribution</span><br><span class="line">#   1us</span><br><span class="line">#  10us</span><br><span class="line"># 100us</span><br><span class="line">#   1ms</span><br><span class="line">#  10ms</span><br><span class="line"># 100ms</span><br><span class="line">#    1s</span><br><span class="line">#  10s+  ################################################################</span><br><span class="line"># Tables</span><br><span class="line">#    SHOW TABLE STATUS FROM &#96;database_base&#96; LIKE &#39;table_list1&#39;\G</span><br><span class="line">#    SHOW CREATE TABLE &#96;database_base&#96;.&#96;table_list1&#96;\G</span><br><span class="line">#    SHOW TABLE STATUS FROM &#96;database_base&#96; LIKE &#39;user_list&#39;\G</span><br><span class="line">#    SHOW CREATE TABLE &#96;database_base&#96;.&#96;user_list&#96;\G</span><br><span class="line"># EXPLAIN &#x2F;*!50100 PARTITIONS*&#x2F;</span><br><span class="line">select SQL_CALC_FOUND_ROWS al.*, ul.Alias as userName</span><br><span class="line">        FROM table_list1 al</span><br><span class="line">        LEFT JOIN user_list ul ON ul.ID &#x3D; al.UserId</span><br><span class="line">         WHERE TRUE  AND (al.SupportCountrys LIKE &#39;%%&#39;)</span><br><span class="line">         limit 80, 10\G</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-pt-query-digest的命令"><a href="#3-2-3-pt-query-digest的命令" class="headerlink" title="3.2.3 pt-query-digest的命令"></a>3.2.3 pt-query-digest的命令</h3><p>以下是使用pt-query-digest的示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;直接分析慢查询文件</span><br><span class="line">pt-query-digest  slow.log &gt; slow_report.log</span><br><span class="line"></span><br><span class="line">分析最近12小时内的查询</span><br><span class="line">pt-query-digest  --since&#x3D;12h  slow.log &gt; slow_report2.log</span><br><span class="line"></span><br><span class="line">分析指定时间范围内的查询</span><br><span class="line">pt-query-digest slow.log --since &#39;2017-01-07 09:30:00&#39; --until &#39;2017-01-07 10:00:00&#39;&gt; &gt; slow_report3.log</span><br><span class="line"></span><br><span class="line">分析含有select语句的慢查询</span><br><span class="line">pt-query-digest --filter &#39;$event-&gt;&#123;fingerprint&#125; &#x3D;~ m&#x2F;^select&#x2F;i&#39; slow.log&gt; slow_report4.log</span><br><span class="line"></span><br><span class="line">针对某个用户的慢查询</span><br><span class="line">pt-query-digest --filter &#39;($event-&gt;&#123;user&#125; || &quot;&quot;) &#x3D;~ m&#x2F;^root&#x2F;i&#39; slow.log&gt; slow_report5.log</span><br><span class="line"></span><br><span class="line">查询所有全表扫描或full join的慢查询</span><br><span class="line">pt-query-digest --filter &#39;(($event-&gt;&#123;Full_scan&#125; || &quot;&quot;) eq &quot;yes&quot;) ||(($event-&gt;&#123;Full_join&#125; || &quot;&quot;) eq &quot;yes&quot;)&#39; slow.log&gt; slow_report6.log</span><br><span class="line"></span><br><span class="line">把查询保存到query_review表</span><br><span class="line">pt-query-digest --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_review--create-review-table  slow.log</span><br><span class="line"></span><br><span class="line">把查询保存到query_history表</span><br><span class="line">pt-query-digest  --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_history--create-review-table  slow.log_0001</span><br><span class="line">pt-query-digest  --user&#x3D;root –password&#x3D;abc123 --review  h&#x3D;localhost,D&#x3D;test,t&#x3D;query_history--create-review-table  slow.log_0002</span><br><span class="line"></span><br><span class="line">通过tcpdump抓取的tcp协议数据，然后分析</span><br><span class="line">tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt</span><br><span class="line">pt-query-digest --type tcpdump mysql.tcp.txt&gt; slow_report9.log</span><br><span class="line"></span><br><span class="line">分析biglog</span><br><span class="line">mysqlbinlog mysql-bin.000093 &gt; mysql-bin000093.sql</span><br><span class="line">pt-query-digest  --type&#x3D;binlog  mysql-bin000093.sql &gt; slow_report10.log</span><br><span class="line"></span><br><span class="line">分析general log</span><br><span class="line">pt-query-digest  --type&#x3D;genlog  localhost.log &gt; slow_report11.log</span><br></pre></td></tr></table></figure>

<p>该工具可以将查询的剖析报告打印出来，可以分析结果输出到文件中，分析过程是先对查询语句的条件进行参数化，然后对参数化以后的查询进行分组统计，统计出各查询的执行时间，次数，占比等，可以借助分析结果找出问题进行优化。</p>
<h2 id="3-3-慢查询日志分析工具mysqldumpslow"><a href="#3-3-慢查询日志分析工具mysqldumpslow" class="headerlink" title="3.3 慢查询日志分析工具mysqldumpslow"></a>3.3 慢查询日志分析工具mysqldumpslow</h2><p>mysqldumpslow是mysql自身提供的日志分析工具，一般在mysql的bin目录下</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-4485cce5b262eea9f252ec10f4ce6b93f8b.png" alt=""></p>
<p>帮助信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ mysqldumpslow.pl --help</span><br><span class="line">Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]</span><br><span class="line"></span><br><span class="line">Parse and summarize the MySQL slow query log. Options are</span><br><span class="line"></span><br><span class="line">  --verbose    verbose</span><br><span class="line">  --debug      debug</span><br><span class="line">  --help       write this text to standard output</span><br><span class="line"></span><br><span class="line">  -v           verbose</span><br><span class="line">  -d           debug</span><br><span class="line"></span><br><span class="line"> -s, 是表示按照何种方式排序</span><br><span class="line">    c: 访问计数</span><br><span class="line"></span><br><span class="line">    l: 锁定时间</span><br><span class="line"></span><br><span class="line">    r: 返回记录</span><br><span class="line"></span><br><span class="line">    t: 查询时间</span><br><span class="line"></span><br><span class="line">    al:平均锁定时间</span><br><span class="line"></span><br><span class="line">    ar:平均返回记录数</span><br><span class="line"></span><br><span class="line">    at:平均查询时间</span><br><span class="line"></span><br><span class="line">-t, 是top n的意思，即为返回前面多少条的数据；</span><br><span class="line">-g, 后边可以写一个正则匹配模式，大小写不敏感的；</span><br><span class="line"></span><br><span class="line">比如:</span><br><span class="line">得到返回记录集最多的10个SQL。</span><br><span class="line">mysqldumpslow -s r -t 10 &#x2F;database&#x2F;mysql&#x2F;mysql06_slow.log</span><br><span class="line"></span><br><span class="line">得到访问次数最多的10个SQL</span><br><span class="line">mysqldumpslow -s c -t 10 &#x2F;database&#x2F;mysql&#x2F;mysql06_slow.log</span><br><span class="line"></span><br><span class="line">得到按照时间排序的前10条里面含有左连接的查询语句。</span><br><span class="line">mysqldumpslow -s t -t 10 -g “left join” &#x2F;database&#x2F;mysql&#x2F;mysql06_slow.log</span><br><span class="line"></span><br><span class="line">另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现刷屏的情况。</span><br><span class="line">mysqldumpslow -s r -t 20 &#x2F;mysqldata&#x2F;mysql&#x2F;mysql06-slow.log | more</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果不能执行，可以先安装perl，然后通过perl mysqldumpslow xxx.log</p>
</blockquote>
<h1 id="4-事务日志"><a href="#4-事务日志" class="headerlink" title="4 事务日志"></a>4 事务日志</h1><p>事务日志包括redo log和undo log，在阐述二者之前，我们必须明确，redo log是InnoDB引擎的一类日志，而不是MySQL服务端的日志。它是InnoDB实现事务的重要机制。</p>
<p>具体内容详见本博客文章《【InnoDB详解四】redo log和undo log》</p>
<h1 id="5-二进制日志"><a href="#5-二进制日志" class="headerlink" title="5 二进制日志"></a>5 二进制日志</h1><p>MySQL的二进制日志（binary log，简称binlog）是一个二进制文件，主要记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的所有操作。二进制日志（binary log）中记录了对MySQL数据库执行更改的所有操作，并且记录了语句发生时间、执行时长、操作数据等其它额外信息，但是它不记录SELECT、SHOW等那些不修改数据的SQL语句。</p>
<p>它和InnoDB的redo log很像，但注意redo log是InnoDB的，是引擎级别的，binlog是MySQL级别的，换言之，不论MySQL使用什么存储引擎，它都会产生binlog。</p>
<h2 id="5-1-binlog的作用"><a href="#5-1-binlog的作用" class="headerlink" title="5.1 binlog的作用"></a>5.1 binlog的作用</h2><ol>
<li><p>恢复（recovery）：某些数据的恢复需要二进制日志。例如，在一个数据库全备文件恢复后，用户可以通过二进制日志进行point-in-time的恢复。</p>
</li>
<li><p>复制（replication）：其原理与恢复类似，通过复制和执行二进制日志使一台远程的MySQL数据库（一般称为slave或者standby）与一台MySQL数据库（一般称为master或者primary）进行实时同步。</p>
</li>
<li><p>审计（audit）：用户可以通过二进制日志中的信息来进行审计，判断是否有对数据库进行注入攻击。</p>
</li>
</ol>
<p>除了上面介绍的几个作用外，binlog对于事务存储引擎的崩溃恢复也有非常重要的作用。</p>
<p>在开启binlog的情况下，为了保证binlog与redo的一致性，MySQL将采用事务的两阶段提交协议。当MySQL系统发生崩溃时，事务在存储引擎内部的状态可能为prepared和commit两种。对于prepared状态的事务，是进行提交操作还是进行回滚操作，这时需要参考binlog：如果事务在binlog中存在，那么将其提交；如果不在binlog中存在，那么将其回滚，这样就保证了数据在主库和从库之间的一致性。</p>
<h2 id="5-2-binlog的存储"><a href="#5-2-binlog的存储" class="headerlink" title="5.2 binlog的存储"></a>5.2 binlog的存储</h2><p>为了管理所有的binlog文件，MySQL额外创建了一个base-name.index文件，它按顺序记录了MySQL使用的所有binlog文件。如果你想自定义index文件的名称，可以设置log_bin_index=file参数。千万不要在mysqld运行的时候手动修改index文件的内容，这样会使mysqld产生混乱。</p>
<h2 id="5-3-binlog的开启"><a href="#5-3-binlog的开启" class="headerlink" title="5.3 binlog的开启"></a>5.3 binlog的开启</h2><p>binlog默认关闭，如果想开启binlog，可以在MySQL配置文件中通过配置参数<code>log-bin = [base-name]</code>启动二进制日志。如果不指定base-name，则默认以主机名为二进制日志的文件名，并以自增的数字作为后缀，例如<code>mysql-bin.000001</code>，所在目录为数据库所在目录（datadir）。</p>
<p>顺序说一下，对于二进制文件当满足下面三种情况时会创建新的文件，文件后缀会自增。</p>
<ol>
<li>文件大小达到<code>max_binlog_size</code>参数设置值时。</li>
<li>执行flush logs命令。</li>
<li>重启mysqld进程。</li>
</ol>
<blockquote>
<p>你可能会有顾虑，当文件后缀从000001增长到999999时会怎样？有网友测试过，当文件达到999999时又会回到000001，并不会有什么异常。</p>
</blockquote>
<h2 id="5-4-binlog格式"><a href="#5-4-binlog格式" class="headerlink" title="5.4 binlog格式"></a>5.4 binlog格式</h2><p>binlog格式分为: STATEMENT、ROW和MIXED三种，详情如下:</p>
<ol>
<li><p>STATEMENT</p>
<ul>
<li>STATEMENT格式的binlog记录的是数据库上执行的原生SQL语句。</li>
<li>这种方式有好处：<ul>
<li>好处就是相当简单，简单地记录和执行这些语句，能够让主备保持同步，在主服务器上执行的SQL语句，在从服务器上执行同样的语句。</li>
<li>另一个好处是二进制日志里的时间更加紧凑，所以相对而言，基于语句的复制模式不会使用太多带宽，同时也节约磁盘空间。并且通过mysqlbinlog工具容易读懂其中的内容。</li>
</ul>
</li>
<li>这种方式也有坏处：<ul>
<li>坏处就是同一条SQL在主库和从库上执行的时间可能稍微或很大不相同，因此在传输的二进制日志中，除了查询语句，还包括了一些元数据信息，如当前的时间戳。<ul>
<li>即便如此，还存在着一些无法被正确复制的SQL。例如，使用INSERT INTO TB1 VALUE(CUURENT_DATE())这一条使用函数的语句插入的数据复制到当前从服务器上来就会发生变化。存储过程和触发器在使用基于语句的复制模式时也可能存在问题。</li>
<li>另外一个问题就是基于语句的复制必须是串行化的。这要求大量特殊的代码，配置，例如InnoDB的next-key锁等。并不是所有的存储引擎都支持基于语句的复制。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ROW</p>
<ul>
<li>从MySQL5.1开始支持基于行的复制，也就是基于数据的复制，基于行的更改。这种方式会将实际数据记录在二进制日志中。</li>
<li>这种方式有好处：<ul>
<li>最大的好处是可以正确地复制每一行数据。一些语句可以被更加有效地复制</li>
<li>另外就是几乎没有基于行的复制模式无法处理的场景，对于所有的SQL构造、触发器、存储过程等都能正确执行。</li>
</ul>
</li>
<li>这种方式也有坏处：<ul>
<li>主要的缺点就是二进制日志可能会很大，而且不直观，所以，你不能使用mysqlbinlog来查看二进制日志。也无法通过看二进制日志判断当前执行到那一条SQL语句了。</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>现在对于ROW格式的二进制日志基本是标配了，主要是因为它的优势远远大于缺点。并且由于ROW格式记录行数据，所以可以基于这种模式做一些DBA工具，比如数据恢复，不同数据库之间数据同步等。</p>
</blockquote>
<ol start="3">
<li><p>MIXED</p>
<ul>
<li>MIXED也是MySQL默认使用的二进制日志记录方式，但MIXED格式默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制。比如用到UUID()、USER()、CURRENT_USER()、ROW_COUNT()等无法确定的函数。</li>
</ul>
</li>
</ol>
<h1 id="6-中继日志"><a href="#6-中继日志" class="headerlink" title="6 中继日志"></a>6 中继日志</h1><p>relay log是复制过程中产生的日志，很多方面都跟binary log差不多，区别是: relay log是从库服务器I/O线程将<strong>主库服务器</strong>的二进制日志读取过来记录到<strong>从库服务器</strong>本地文件，然后<strong>从库</strong>的SQL线程会读取relay-log日志的内容并应用到<strong>从库服务器</strong>上。</p>
<h2 id="6-1-中继日志参数"><a href="#6-1-中继日志参数" class="headerlink" title="6.1 中继日志参数"></a>6.1 中继日志参数</h2><ul>
<li><p>max_relay_log_size<br>标记relay log 允许的最大值，如果该值为0，则默认值为max_binlog_size(1G)；如果不为0，则max_relay_log_size则为最大的relay_log文件大小；</p>
</li>
<li><p>relay_log<br>定义relay_log的位置和名称，如果值为空，则默认位置在数据文件的目录，文件名为host_name-relay-bin.nnnnnn（By default, relay log file names have the form host_name-relay-bin.nnnnnn in the data directory）；</p>
</li>
<li><p>relay_log_index<br>同relay_log，定义relay_log的位置和名称；</p>
</li>
<li><p>relay_log_info_file<br>设置<code>http://relay-log.info</code>的位置和名称（<a href="http://relay-log.info记录MASTER的binary_log的恢复位置和relay_log的位置）" target="_blank" rel="noopener">http://relay-log.info记录MASTER的binary_log的恢复位置和relay_log的位置）</a></p>
</li>
<li><p>relay_log_purge<br>是否自动清空不再需要中继日志时。默认值为1(启用)。</p>
</li>
<li><p>relay_log_recovery<br>当slave从库宕机后，假如relay-log损坏了，导致一部分中继日志没有处理，则自动放弃所有未执行的relay-log，并且重新从master上获取日志，这样就保证了relay-log的完整性。默认情况下该功能是关闭的，将relay_log_recovery的值设置为 1时，可在slave从库上开启该功能，建议开启。</p>
</li>
<li><p>relay_log_space_limit<br>防止中继日志写满磁盘，这里设置中继日志最大限额。但此设置存在主库崩溃，从库中继日志不全的情况，不到万不得已，不推荐使用；</p>
</li>
<li><p>sync_relay_log<br>这个参数和sync_binlog是一样的，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入relay log中继日志里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入中继日志里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改。</p>
</li>
<li><p>sync_relay_log_info<br>这个参数和sync_relay_log参数一样，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入<code>http://relay-log.info</code>里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入<code>http://relay-log.info</code> 里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改。</p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
            <a href="/tags/InnoDB/" rel="tag"># InnoDB</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/27/%E3%80%90InnoDB%E8%AF%A6%E8%A7%A3%E5%9B%9B%E3%80%91redo-log%E5%92%8Cundo-log/" rel="next" title="【InnoDB详解四】redo log和undo log">
                <i class="fa fa-chevron-left"></i> 【InnoDB详解四】redo log和undo log
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/10/14/JAVA%E5%86%85%E7%BD%AE%E6%8E%92%E5%BA%8FArrays-sort%E5%AE%9E%E7%8E%B0%E7%AE%80%E8%BF%B0/" rel="prev" title="JAVA内置排序Arrays.sort实现简述">
                JAVA内置排序Arrays.sort实现简述 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2020/09/30/MySQL日志体系详解/"
           data-title="MySQL日志体系详解" data-url="http://yoursite.com/2020/09/30/MySQL%E6%97%A5%E5%BF%97%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://oscimg.oschina.net/oscnet/up-c01f8b7b68770ed58c420d68072f773a30b.png"
                alt="cherish-ls" />
            
              <p class="site-author-name" itemprop="name">cherish-ls</p>
              <p class="site-description motion-element" itemprop="description">纸上得来终觉浅</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">68</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">92</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="git@github.com:cherish-ls/cherish-ls.github.io.git" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-错误日志"><span class="nav-text">1 错误日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-错误日志的内容"><span class="nav-text">1.1 错误日志的内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-配置相关"><span class="nav-text">1.2 配置相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-开启错误日志"><span class="nav-text">1.2.1 开启错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-设置错误日志时区"><span class="nav-text">1.2.2 设置错误日志时区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-删除错误日志"><span class="nav-text">1.2.3 删除错误日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-查看错误日志和配置"><span class="nav-text">1.3 查看错误日志和配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-查询日志"><span class="nav-text">2 查询日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-查询日志配置相关"><span class="nav-text">2.1 查询日志配置相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-查看配置"><span class="nav-text">2.1.1 查看配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-开启或关闭查询日志"><span class="nav-text">2.1.2 开启或关闭查询日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-修改查询日志名称或位置"><span class="nav-text">2.1.3 修改查询日志名称或位置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-查询日志的查看"><span class="nav-text">2.2 查询日志的查看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-查询日志的归档"><span class="nav-text">2.3 查询日志的归档</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-慢查询日志"><span class="nav-text">3 慢查询日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-慢查询日志配置相关"><span class="nav-text">3.1 慢查询日志配置相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-查看配置"><span class="nav-text">3.1.1 查看配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-开启或关闭慢查询日志"><span class="nav-text">3.1.2 开启或关闭慢查询日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-查看当前有多少条慢日志"><span class="nav-text">3.1.3 查看当前有多少条慢日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-慢查询日志分析工具pt-query-digest"><span class="nav-text">3.2 慢查询日志分析工具pt-query-digest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-pt-query-digest的使用"><span class="nav-text">3.2.1 pt-query-digest的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-pt-query-digest的结果"><span class="nav-text">3.2.2 pt-query-digest的结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-pt-query-digest的命令"><span class="nav-text">3.2.3 pt-query-digest的命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-慢查询日志分析工具mysqldumpslow"><span class="nav-text">3.3 慢查询日志分析工具mysqldumpslow</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-事务日志"><span class="nav-text">4 事务日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-二进制日志"><span class="nav-text">5 二进制日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-binlog的作用"><span class="nav-text">5.1 binlog的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-binlog的存储"><span class="nav-text">5.2 binlog的存储</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-binlog的开启"><span class="nav-text">5.3 binlog的开启</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-binlog格式"><span class="nav-text">5.4 binlog格式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-中继日志"><span class="nav-text">6 中继日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-中继日志参数"><span class="nav-text">6.1 中继日志参数</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cherish-ls</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">457.4k</span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"cherish"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: true,
        appId: 'TQhjcmooFXWGQ3qgqUroDKsD-gzGzoHsz',
        appKey: 'zjA9PvG5eljY1JErig8WVQQD',
        placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
